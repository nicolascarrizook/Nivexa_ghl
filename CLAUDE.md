# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Nivexa is a financial management system specialized for architecture studios with a triple cash box system and project financing features. Built with React 19, TypeScript, Vite 7, Tailwind CSS v4, and Supabase (PostgreSQL).

## Development Commands

```bash
# Start development server on port 3001
npm run dev

# Build with TypeScript checks (recommended)
npm run build

# Build without TypeScript checks (faster)
npm run build:fast

# Run linter
npm run lint

# Testing commands
npm test                    # Run all tests
npm run test:ui            # Run tests with UI
npm run test:coverage      # Run with coverage report
npm run test:watch         # Run in watch mode

# Storybook (component development)
npm run storybook          # Start Storybook on port 6006
npm run build-storybook    # Build Storybook

# Database setup
npm run setup:auth         # Setup authentication
npm run db:setup          # Setup database
```

## Database Setup

1. Go to [Supabase Dashboard](https://supabase.com/dashboard)
2. Navigate to SQL Editor
3. Execute `supabase/migrations/001_initial_schema.sql`
4. Execute subsequent migration files in order

## Architecture and Key Concepts

### Progressive Architecture with Service Layer

The codebase follows a progressive architecture pattern with a clear service layer abstraction:

- **BaseService**: Abstract base class (`src/core/services/BaseService.ts`) providing generic CRUD operations with type safety
- **Domain Services**: Extend BaseService for domain-specific logic (ProjectService, CashBoxService)
- **Service Pattern**: All services return `ServiceResponse<T>` with `{ data, error }` structure for consistent error handling

### Triple Cash Box System

Core business logic implementing a specialized financial flow:

1. **Master Cash Box** (`master_cash_box` table): Main studio cash box
   - Automatically receives duplicates of all project income
   - Source for architect fee collection

2. **Admin Cash Box** (`admin_cash`): Personal architect cash box
   - Receives manual fee collections from master cash
   - Architect decides when and how much to collect

3. **Project Cash Boxes** (`project_cash_box` table): One per project
   - Receives project payments
   - Tracks project-specific finances

**Critical Business Rules**:
- All project income automatically duplicates to master cash
- Fee collection is manual from master to admin (architect's decision)
- Complete traceability through `cash_movements` table
- Each movement has source/destination types and IDs

### Multi-Currency Support

The system supports ARS (Argentine Peso) and USD:
- Cash boxes have separate balance fields: `current_balance_ars`, `current_balance_usd`
- All monetary amounts validated with `isValidCurrencyAmount()` to prevent overflow
- Validation enforced in `src/core/utils/validation.ts`
- Maximum values defined in currency validation functions

### Module Structure

```
src/
├── core/                     # Framework-level code
│   ├── services/            # BaseService, AuthService, SentryService
│   ├── contexts/            # React contexts
│   └── providers/           # Provider components
├── modules/                 # Domain-specific modules
│   ├── projects/            # Project management
│   │   ├── services/ProjectService.ts
│   │   ├── hooks/
│   │   └── components/
│   ├── finance/             # Financial system
│   │   └── services/CashBoxService.ts
│   ├── clients/             # Client management
│   └── providers/           # Contractor/provider management
├── components/              # Shared UI components
│   └── ui/                 # shadcn/ui components
├── pages/                  # Page components (route targets)
└── types/                  # TypeScript type definitions
    └── database.types.ts   # Supabase generated types
```

### Path Aliases

Configured in both `tsconfig.app.json` and `vite.config.ts`:

```typescript
@/          → ./src/
@components → ./src/components/
@core       → ./src/core/
@modules    → ./src/modules/
@hooks      → ./src/hooks/
@utils      → ./src/utils/
@types      → ./src/types/
```

Always use these aliases for imports instead of relative paths.

### Project Code Generation

Projects receive unique codes in format `PRY-YYYY-###`:
- Generated by `ProjectService.generateProjectCode()`
- Sequential numbering per year
- Example: `PRY-2024-001`, `PRY-2024-002`

### Installment System

Projects support financing with installments:
- Installment 0 = down payment (anticipo)
- Installments 1-N = regular payments
- Payment frequencies: monthly, weekly, biweekly, quarterly
- Status tracking: pending, paid, overdue
- Late fee calculation with configurable grace periods
- Automatic installment generation based on project configuration

## Technology Stack Details

### TypeScript Configuration

- Strict mode: **disabled** (`strict: false` in tsconfig.app.json)
- Unused locals/parameters checking: **disabled**
- Target: ES2022
- Module resolution: bundler mode
- Composite project structure with references

**Important**: When adding strict type checking, expect significant refactoring needs.

### Supabase Integration

- Database types generated in `src/types/database.types.ts`
- Row Level Security (RLS) enabled on all tables
- Real-time subscriptions available via `BaseService.subscribeToChanges()`
- Configuration in `src/config/supabase.ts`

### Testing Setup

- Framework: Vitest with happy-dom
- React Testing Library configured
- Coverage configured with v8 provider
- Setup file: `src/test/setup.ts`
- Run individual test: `npm test -- path/to/test.test.ts`

### UI Component Library

- shadcn/ui components in `src/components/ui/`
- Radix UI primitives for accessible components
- Tailwind CSS v4 with new Vite plugin
- Framer Motion for animations
- Lucide React for icons
- Dark theme configured with next-themes

### State Management

- React Query (TanStack Query) for server state
- Zustand for client state (`src/core/store/`)
- React Context for cross-cutting concerns
- Form state with react-hook-form + Zod validation

## Common Development Tasks

### Adding a New Table/Service

1. Run Supabase migration to create table
2. Regenerate types: Check Supabase docs for type generation
3. Create service extending `BaseService<'table_name'>`
4. Add type exports using generated `Tables<'table_name'>` type
5. Create custom hooks in `modules/[domain]/hooks/`

### Working with Cash Movements

Always use the service layer methods:
- `CashBoxService.recordProjectIncome()` - For project payments (auto-duplicates to master)
- `CashBoxService.collectFees()` - For manual fee collection (master → admin)
- `CashBoxService.recordExpense()` - For expenses from any cash box

Never manually update cash box balances - always create movements first.

### Form Validation

Forms use react-hook-form with Zod:
```typescript
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';

const schema = z.object({ /* ... */ });
const form = useForm({ resolver: zodResolver(schema) });
```

Currency amounts should be validated with utility functions from `@core/utils/validation.ts`.

### Error Handling Pattern

Services return `ServiceResponse<T>`:
```typescript
const { data, error } = await service.method();
if (error) {
  // Handle error
  return;
}
// Use data
```

React Query hooks handle async state automatically.

## Database Schema Key Relationships

- `projects` → `project_cash_box` (1:1)
- `projects` → `installments` (1:N)
- `installments` → `payments` (1:N)
- Cash movements track all financial flows with source/destination references
- `fee_collections` links to `cash_movements` via `movement_id`

## Important Constraints

- All monetary operations must validate amounts to prevent database overflow
- Project creation includes automatic cash box creation (atomic operation)
- Down payment confirmation is separate from project creation
- RLS policies require authenticated users for all operations
- Each cash box movement must have corresponding balance updates
